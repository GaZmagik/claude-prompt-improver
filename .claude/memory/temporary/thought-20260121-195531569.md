---
type: breadcrumb
title: "Think: Dynamic Context Injection v1.2.0 - Exploration Phase"
topic: Dynamic Context Injection v1.2.0 - Exploration Phase
status: concluded
created: "2026-01-21T19:55:31.572Z"
updated: "2026-01-21T19:56:47.923Z"
tags:
  - think
  - concluded
scope: project
conclusion: |-
  Exploration conclusion - Key architectural decisions:

  1. FILESYSTEM SCANNING: Use Node.js fs.readdir({ recursive: true, withFileTypes: true }) for efficient directory traversal
  2. CACHING: Implement LRU cache with mtime validation (pattern from spec-awareness.ts)
  3. PARSING: Reuse existing parseFrontmatter() for YAML (no new dependencies, follows P5 Simplicity)
  4. INTEGRATION POINT: Create new integrations/dynamic-discovery.ts following established integration pattern
  5. SPECIAL CASE: Detect 'memory think' in prompt, inject available --agent and --style suggestions

  OPEN QUESTIONS for /speckit:specify:
  - File format confirmation for skills, commands, output-styles
  - Plugin directory nested discovery depth
  - Whether to include commands in initial scope
  - Performance impact of scanning on every prompt

  Next step: Generate specify and plan prompts
promotedTo: decision-dynamic-context-injection-v1-2-0-exploration-phase
---

# Dynamic Context Injection v1.2.0 - Exploration Phase

_Thinking document created 2026-01-21T19:55:31.572Z_

## Thoughts

### 2026-01-21T19:55:47.680Z - Thought
Key findings from codebase exploration:
1. Existing infrastructure: skill-matcher.ts and agent-suggester.ts already exist but use hardcoded JSON/arrays
2. Pattern established: spec-awareness.ts uses mtime-based LRU cache for file caching
3. Context builder uses Promise.allSettled for parallel async gathering
4. Integration pattern: gather function (async), format function, options interface with _mockFileSystem
5. Agent parsing: parseAgentDefinition() already parses markdown frontmatter (name, description, keywords)
6. Skill loading: loadSkillRules() expects JSON format with skills array
7. Keyword matching: Shared matchItemsByKeywords() utility in keyword-matcher.ts

### 2026-01-21T19:56:05.123Z - Thought
Research findings on filesystem scanning:
1. Node.js fs.readdir supports recursive mode with { recursive: true, withFileTypes: true }
2. withFileTypes returns Dirent objects - avoids additional syscalls for isDirectory() checks
3. Performance consideration: Use Dirent to check file type without extra stat calls
4. Async/await approach preferred for recursive scanning
5. Error handling critical: ENOENT (not found), EACCES (permission), ENOTDIR (not a directory)
6. Symlink consideration: Don't follow by default to avoid infinite loops

### 2026-01-21T19:56:06.907Z - Thought
YAML frontmatter parsing research:
1. Project already has custom YAML parser in spec-awareness.ts (parseFrontmatter function)
2. External options: gray-matter (battle-tested), vfile-matter (TypeScript-first, ESM)
3. Constitution P5 (Simplicity & YAGNI): Avoid dependencies unless necessary
4. Existing parser handles simple YAML (key: value, arrays with - prefix)
5. Decision: Reuse existing parseFrontmatter pattern - no new dependencies needed
6. Agent parsing already uses frontmatter (name, description fields)

### 2026-01-21T19:56:08.613Z - Thought
Special case: memory think integration
- User request mentions 'memory think' should suggest deliberation with available agents/styles
- Memory plugin already exists (memory-plugin.ts) with gatherMemoryContext
- New feature should detect 'memory think' in prompt
- When detected, scan for ~/.claude/output-styles/ and suggest --style and --agent options
- This is context enrichment, not functional change
- Suggestion format: Inject into improved prompt as available options

### 2026-01-21T19:56:30.678Z - Thought
Architecture decision - Caching strategy:
1. spec-awareness.ts uses LRU cache with mtime validation (MAX_CACHE_SIZE=50)
2. Cache invalidation: Check mtime on every access, reread if changed
3. Cache benefits: Avoid repeated filesystem reads during same hook execution
4. For dynamic context: Cache discovered agents/skills/commands/styles per directory
5. Cache key: Directory path -> CacheEntry { items: T[], mtimeMs: number }
6. LRU eviction when cache exceeds limit
7. Must handle cache correctly in tests with _mockFileSystem option

### 2026-01-21T19:56:32.633Z - Thought
Integration with context-builder.ts:
1. Current flow: buildContext() calls gatherSyncContext() then buildAsyncTasks()
2. Skills/agents currently provided via input parameters (skillRules, agentDefinitions)
3. NEW: Need filesystem scanning integration to populate these arrays
4. Option 1: Scan in hook entry point, pass to buildContext (maintains separation)
5. Option 2: Scan inside context-builder (violates single responsibility)
6. DECISION: Option 1 - scan in improve-prompt.ts entry point, pass to context builder
7. Keeps context-builder pure (takes data, builds context) vs filesystem-aware

### 2026-01-21T19:56:34.636Z - Counter-argument
Counter: Filesystem scanning could be its own integration
- Following the pattern of git-context, lsp-diagnostics, spec-awareness, memory-plugin
- Create new integration: dynamic-discovery.ts with gatherDynamicContext()
- Returns: { agents: AgentDefinition[], skills: SkillRule[], commands: CommandDef[], styles: StyleDef[] }
- Benefits: Testable in isolation, follows established pattern, async gathering
- Downside: More files, more complexity
- Question: Is this actually an 'integration' or just a 'loader'?

### 2026-01-21T19:56:36.679Z - Thought
Scope clarification - What gets discovered:
1. Agents: ~/.claude/agents/*.md and .claude/agents/*.md (markdown with frontmatter)
2. Skills: ~/.claude/skills/*.json and .claude/skills/*.json (JSON format? Or also markdown?)
3. Commands: ~/.claude/commands/* and .claude/commands/* (what format?)
4. Output styles: ~/.claude/output-styles/*.md and .claude/output-styles/*.md
5. Plugin directories: ~/.claude/plugins/*/skills/ (nested discovery)
6. QUESTION: What format are skills/commands/styles? Need to verify actual file formats used

### 2026-01-21T19:56:47.923Z - Conclusion
Exploration conclusion - Key architectural decisions:

1. FILESYSTEM SCANNING: Use Node.js fs.readdir({ recursive: true, withFileTypes: true }) for efficient directory traversal
2. CACHING: Implement LRU cache with mtime validation (pattern from spec-awareness.ts)
3. PARSING: Reuse existing parseFrontmatter() for YAML (no new dependencies, follows P5 Simplicity)
4. INTEGRATION POINT: Create new integrations/dynamic-discovery.ts following established integration pattern
5. SPECIAL CASE: Detect 'memory think' in prompt, inject available --agent and --style suggestions

OPEN QUESTIONS for /speckit:specify:
- File format confirmation for skills, commands, output-styles
- Plugin directory nested discovery depth
- Whether to include commands in initial scope
- Performance impact of scanning on every prompt

Next step: Generate specify and plan prompts
